<!DOCTYPE html>
<html>
<head>
	<title>Achewood! ...mobile!</title>
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<link rel="stylesheet" type="text/css" href="css/jquery.mobile-1.3.2.css">
	<style>
		h1.logo: { font-family: "Lobster"; }
	</style>
	<script src="js/jquery-2.0.3.js" ></script>
	<script src="js/jquery.mobile-1.3.2.js" ></script>
	<script src="js/plugins/cross-domain-ajax/jquery.xdomainajax.js"></script>
	<script src="js/plugins/panzoom/jquery.panzoom.min.js"></script>
	<script language="JavaScript">
		const ACHEWOOD_BASE_URL = 'http://www.achewood.com';
		var $prevComicLink;
		var $nextComicLink;
		var $comicTarget;
		var $altTextLink;
		var loadingQuotes = [
			"Here comes a special boy!",
			"We got the chessboard out but you playin' whack-a-mole.",
			"You big hot tranny mess!",
			"You can do whatever you want in life.",
			"I'm definitely not afraid of the police right now!",
			"Kiss my ass, bitch! I'll be at Dwayne's!",
			"Calculating eggs & milk..."
		];

		function loadPage(event) {

			$altTextLink = $("a#comicAltLink");
			$altTextLink.unbind('click');
			$altTextLink.click(function() { $.mobile.loading('show', {text: 'loading!', theme: 'c', textonly: false}); } );

			$comicTarget = $("img#comicTarget");
			$prevComicLink = $("a#comicPrev");
			$nextComicLink = $("a#comicNext");

			loadAchewood(event);
		}

		function loadAchewood(event) { 
			var url;
			var loadUrl = ACHEWOOD_BASE_URL;

			//if the parameter is passed, use it to load the correct comic url
			if (event && event.data) { url = event.data.urlParam; }
			if (url) { loadUrl = ACHEWOOD_BASE_URL + '/' + url; }


			$.mobile.loading('show', {
				text: loadingQuotes[Math.floor(Math.random()*loadingQuotes.length)],
				theme: "a",
				textVisible: true
			});

			$.get(loadUrl, parseAchewood );

		}

		function parseAchewood( achewoodIndex ) {
            //cross platform xml object creation from w3schools
            try { //Internet Explorer
              xmlDoc = new ActiveXObject("Microsoft.XMLDOM");
              xmlDoc.async="false";
              xmlDoc.loadXML(achewoodIndex.responseText);
            }
            catch(e) {
              try { // Firefox, Mozilla, Opera, etc.
                parser = new DOMParser();
                xmlDoc = parser.parseFromString(achewoodIndex.responseText,"text/xml");
			  }
              catch(e) {
                alert(e.message);
                return;
	          }
            }

            getComic(xmlDoc.getElementsByTagName("body")[0].innerHTML);

            // console.log(xmlDoc.getElementsByTagName("body")[0].innerHTML); //[0].childNodes[0].nodeValue));
        }

		function getComic( content ) {

			var $comic = $("img.comic", $(content));
			
			$comicTarget.attr({
				src: ACHEWOOD_BASE_URL + $comic.attr("src") ,
				width: "100%",
				height: "100%"
				// title: $comic.attr("title")		
			});

			$("div#comicAlt").html($comic.attr("title"));
			
			$prevComicLink.unbind('click');
			$prevComicLink.achewoodLink = $( "a.dateNav[title=\"Previous comic\"]", $(content)).attr("href");
			$prevComicLink.click({urlParam: $prevComicLink.achewoodLink }, loadAchewood);

			var nextUrl = $("a.dateNav[title=\"Next comic\"]", $(content)).attr("href");
			$nextComicLink.unbind('click');
			if (nextUrl) { 
				$nextComicLink.achewoodLink = nextUrl;
				$nextComicLink.click({urlParam: nextUrl}, loadAchewood);
			} else {
				$nextComicLink.buttonMarkup('disable');
			}
			$comicTarget.panzoom('reset');
			$.mobile.loading('hide');
		}
	</script>
</head>
<body data-role="page">
	<div data-role="header">
		<a class="ui-btn-left" data-iconpos="left" data-icon="arrow-l" id="comicPrev" href="#">Prev</a>
		<h1 class="logo">achewood.</h1>
		<a class="ui-btn-right" data-iconpos="right" data-icon="arrow-r" id="comicNext" href="#">Next</a>
	</div>
	<div data-role="content">
		<div id="comicTarget">
			<img id="comicTarget" src="img/1x1.png" />
		</div>
		<script>
			(function() {
	          var $section = $('div#comicTarget');
	          $section.find('img#comicTarget').panzoom({
	            startTransform: 'scale(0.5)',
	            increment: 0.5,
	            minScale: 1,
	            contain: 'invert'
	          }).panzoom('zoom');
	        })();
		</script>

		<div id="comicAlt">&nbsp;</div>
	</div>
	<div data-role="footer">
		<a data-role="button" data-theme="b" data-iconpos="left" data-icon="star" href="http://achewood.myshopify.com/" target="_blank" id="shopLink">Shop Achewood, Feel Classy.</a>
	</div>
</body>

<script language="javascript" >
	$( document ).ready( loadPage );
	$( document ).on( "mobileinit", function() {
	  $.mobile.loader.prototype.options.text = "loading";
	  $.mobile.loader.prototype.options.textVisible = true;
	  $.mobile.loader.prototype.options.theme = "b";
	  $.mobile.loader.prototype.options.html = "";
	});
</script>

</html>